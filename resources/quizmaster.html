<!doctype html>
<html style="display:none">
<head>
<meta http-equiv="x-ua-compatible" content="IE=Edge"/> 
<meta charset="utf-8"/>
<title>CrowdQuiz - Quizmaster</title>
<link rel="stylesheet" type="text/css" href="styles.css"/>
</head>
<body>

<div id="centercol">
	<div id="questiontext" data-i18n="noquizloaded"></div>

</div>

<div id="controls">
	<input type="file" id="files" name="files[]" />
	<button id="prev" data-i18n="prevquestion"></button>
	<button id="next" data-i18n="nextquestion"></button>
	<button id="reveal" data-i18n="revealanswer"></button>
	<span id="progress"></span>
	<span id="answercount">(0)</span>
</div>


<script src="/socket.io/socket.io.js"></script>
<script src="/jquery.js"></script>
<script src="/i18next.js"></script>
<script src="/shared.js"></script>
<script>
var socket = io();
var questions = [];
var currentquestion = -1;
var answers = [];
var revealed = 0;
var quizname = "Quiz";
var quizinstance = "quiz1";
var qr = new QuizRenderer("#centercol");

i18n.init({ fallbackLng: 'en' }, function(t) {
	// apply i18n and show page
	$("html").i18n().css("display", "initial");
	openQuiz();
});



function openQuiz() {
	quizname = prompt(i18n.t("enterquizname"), "Quiz-" + ((Math.random() * 65536)|0));
	quizinstance = "quiz-" + socket.id;

	socket.emit("JoinRoom", ["quizmaster." + quizinstance, "quizmaster"]);
}


function handleFileSelect(evt) {
	var files = evt.target.files; // FileList object
	var f = files[0];
	var reader = new FileReader();

	// Closure to capture the file information.
	reader.onload = (function (theFile) {
        	return function (e) { 
			questions = JSON.parse(e.target.result);
			currentquestion = -1;
			nextQuestion();
        	};
	})(f);

	// Read in JSON as a data URL.
	reader.readAsText(f, 'UTF-8');
}
document.getElementById('files').addEventListener('change', handleFileSelect, false);


function updateProgress() {
	$("#progress").text("(" + (currentquestion + 1) + "/" + questions.length + ")");
}


function prevQuestion() {
	if(!questions || questions.length < 1) {
		return;
	}

	--currentquestion;
	if(currentquestion < 0) {
		currentquestion = 0;
		return;
	}

	sendQuestion();
}


function nextQuestion() {
	if(!questions || questions.length < 1) {
		return;
	}

	++currentquestion;
	if(currentquestion >= questions.length) {
		currentquestion = questions.length - 1;
		return;
	}

	sendQuestion();
}

function sendQuestion() {
	var question = questions[currentquestion];

	// reset question-related state
	answers = [];
	revealed = 0;
	$("#answercount").text("");

	// send question to clients
	var questionEnvelope = {
		"question" : question,
		"quizinstance" : quizinstance
	};
	socket.emit("QuizQuestion", questionEnvelope);

	updateProgress();
	qr.renderQuestion(question);
}


$("#prev").click(function() {
	prevQuestion();
});
     
$("#next").click(function() {
	nextQuestion();
});

$("#reveal").click(function() {
	if(revealed) {
		return;
	}
	revealed = 1;

	var revealMsg = {
		"quizinstance" : quizinstance
	};

	socket.emit("RevealCorrect", revealMsg);
	qr.revealAnswer();
	qr.revealVote(answers);
});


// received an answer from a client
socket.on("QuizAnswer", function(answer) {

	// don't count if we already revealed the solution
	if(revealed) {
		return;
	}

	answers[answer.from] = answer.index;

	$("#answercount").text("(" + Object.keys(answers).length + ")");
});

// serve question request for clients that connected late
socket.on("RequestQuestion", function(request) {

	if(revealed) {
		return;		// don't send revealed questions
	}

	var question = questions[currentquestion];
	if(!question) {
		return;		// we may not yet have loaded a quiz
	}

	var questionEnvelope = {
		"question" : question,
		"quizinstance" : quizinstance,
		"recipient" : request.clientid
	};

	socket.emit("QuizQuestion", questionEnvelope);
});


socket.on("DiscoveryRequest", function(request) {
	var response = {
		"quizname" : quizname,
		"quizinstance" : quizinstance,
		"recipient" : request.clientid
	};

	socket.emit("DiscoveryResponse", response);
});

socket.on('ping', function(data){
	socket.emit('pong', data);
});


</script>

</body>
</html>
