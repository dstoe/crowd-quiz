<!doctype html>
<html>
<head>
<meta http-equiv="x-ua-compatible" content="IE=Edge"/> 
<meta charset="utf-8"/>
<title>CrowdQuiz - Quizmaster</title>
<link rel="stylesheet" type="text/css" href="styles.css"/>
</head>
<body>

<div id="centercol">
	<div id="questiontext">
	Noch kein Quiz geladen.
	</div>

	<img id="questionimage"/>
	<div class="spacer"></div>

	<ul id="optionlist"></ul>
</div>

<div id="controls">
	<input type="file" id="files" name="files[]" />
	<button id="prev">Vorherige Frage</button>
	<button id="next">NÃ¤chste Frage</button>
	<button id="reveal">Antwort aufdecken</button>
	<span id="progress"></span>
	<span id="answercount">(0)</span>
</div>


<script src="/socket.io/socket.io.js"></script>
<script src="/jquery.js"></script>
<script src="/shared.js"></script>
<script>
var socket = io();
var questions = [];
var currentquestion = -1;
var answers = [];
var revealed = 0;
var quizname = "Quiz";
var quizinstance = "quiz1";


openQuiz();


function openQuiz() {
	quizname = prompt("Bitte benennen Sie Ihren Quiz-Raum","Quizz-" + ((Math.random() * 65536)|0));
	quizinstance = "quiz-" + socket.id;

	socket.emit("JoinRoom", ["quizmaster." + quizinstance, "quizmaster"]);
}


function handleFileSelect(evt) {
	var files = evt.target.files; // FileList object
	var f = files[0];
	var reader = new FileReader();

	// Closure to capture the file information.
	reader.onload = (function (theFile) {
        	return function (e) { 
			questions = JSON.parse(e.target.result);
			currentquestion = -1;
			nextQuestion();
        	};
	})(f);

	// Read in JSON as a data URL.
	reader.readAsText(f, 'UTF-8');
}
document.getElementById('files').addEventListener('change', handleFileSelect, false);


function updateProgress() {
	$("#progress").text("(" + (currentquestion + 1) + "/" + questions.length + ")");
}


function prevQuestion() {
	if(!questions || questions.length < 1) {
		return;
	}

	--currentquestion;
	if(currentquestion < 0) {
		currentquestion = 0;
		return;
	}

	sendQuestion();
}


function nextQuestion() {
	if(!questions || questions.length < 1) {
		return;
	}

	++currentquestion;
	if(currentquestion >= questions.length) {
		currentquestion = questions.length - 1;
		return;
	}

	sendQuestion();
}

function sendQuestion() {
	var question = questions[currentquestion];

	// reset question-related state
	answers = [];
	revealed = 0;
	$("#answercount").text("");

	// send question to clients
	var questionEnvelope = {
		"question" : question,
		"quizinstance" : quizinstance
	};
	socket.emit("QuizQuestion", questionEnvelope);

	updateProgress();
	displayQuestion(question);
}

function displayAnswerCount() {
	for(var i = 0; i < 999; ++i) {
		var option = $("#option" + i);
		if(!option.length) {
			break;
		}

		var originalidx = option.attr("originalindex");
		


		var count = answers[originalidx];
		if(!count) {
			count = 0;
		}
		$("#optioncount" + i).text(count);

		//var text = option.text();
		//text += " (" + count + ")";
		//option.text(text);
	}
}


$("#prev").click(function() {
	prevQuestion();
});
     
$("#next").click(function() {
	nextQuestion();
});

$("#reveal").click(function() {
	if(revealed) {
		return;
	}
	revealed = 1;

	var revealMsg = {
		"quizinstance" : quizinstance
	};

	socket.emit("RevealCorrect", revealMsg);
	revealCorrect();
	displayAnswerCount();
});


// received an answer from a client
socket.on("QuizAnswer", function(answer) {

	// don't count if we already revealed the solution
	if(revealed) {
		return;
	}

	// ensure we have a registry of voters...
	if(!answers.voters) {
		answers.voters = [];
	}
	// ... and reject duplicate answers
	if(answers.voters[answer.from]) {
		return;
	}
	answers.voters[answer.from] = true;


	var selected = answer.index;
	if(!answers[selected]) {
		answers[selected] = 0;
	}
	answers[selected] = answers[selected] + 1;

	var count = 0;
	for(var i = 0; i < answers.length; ++i) {
		if(answers[i]) {
			count += answers[i];
		}
	}

	$("#answercount").text("(" + count + ")");

});

// serve question request for clients that connected late
socket.on("RequestQuestion", function(request) {

	if(revealed) {
		return;		// don't send revealed questions
	}

	var question = questions[currentquestion];
	if(!question) {
		return;		// we may not yet have loaded a quiz
	}

	var questionEnvelope = {
		"question" : question,
		"quizinstance" : quizinstance,
		"recipient" : request.clientid
	};

	socket.emit("QuizQuestion", questionEnvelope);
});


socket.on("DiscoveryRequest", function(request) {
	var response = {
		"quizname" : quizname,
		"quizinstance" : quizinstance,
		"recipient" : request.clientid
	};

	socket.emit("DiscoveryResponse", response);
});

socket.on('ping', function(data){
	socket.emit('pong', data);
});


</script>

</body>
</html>
