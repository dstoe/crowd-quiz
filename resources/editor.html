<!doctype html>
<html style="display:none">
<head>
<meta http-equiv="x-ua-compatible" content="IE=Edge"/> 
<meta charset="utf-8"/>
<title>CrowdQuiz - Editor</title>

<style>

body {
	font-family: Arial,sans-serif;
}

select#questions {
	width: 100%;
}

div.controls {
	background-color: rgb(220,220,220);
	padding:5px;

}

div.editor {
	background-color: rgb(150,150,180);
	padding: 5px;
}

div.editor input {
	width: 90%;
	margin-bottom: 3px;
}

div.editor textarea {
	width: 90%;
	margin-bottom: 6px;
}


input.correct {
	background-color: rgb(200,255,200);
}

input.incorrect {
	background-color: rgb(255,200,200);
}

</style>

</head>
<body>

<div class="controls">
<button id="newquestion" onClick="newQuiz();" data-i18n="newquiz"></button>
<input type="file" id="files" name="files[]" onChange="loadFile();"/>
<a href="" id="savelink" download="quiz.json" onClick="saveToFile();"><button type="button" data-i18n="savetofile"></button></a>
</div>

<div>
<select id="questions" size="10" onChange="onQuestionSelect();"></select>
</div>

<div class="controls">
<button id="newquestion" onClick="newQuestion();" data-i18n="newquestion"></button>
<button id="removequestion" onClick="removeQuestion();" data-i18n="deletequestion"></button>
<button id="questionup" onClick="upQuestion();" data-i18n="questionup"></button>
<button id="questiondown" onClick="downQuestion();" data-i18n="questiondown"></button>
<button id="deleteimage" onClick="deleteImage();" data-i18n="removeimage"></button>
</div>


<div class="editor">
<textarea id="text" cols="80" onChange="readQuestionEditor();"></textarea><br/>
<input type="text" id="option0" class="correct" onChange="readQuestionEditor();"/><br/>
<input type="text" id="option1" class="incorrect" onChange="readQuestionEditor();"/><br/>
<input type="text" id="option2" class="incorrect" onChange="readQuestionEditor();"/><br/>
<input type="text" id="option3" class="incorrect" onChange="readQuestionEditor();"/><br/>
</div>

<p data-i18n="dragimagehere"></p>

<img id="questionimage"/>


<script src="/jquery.js"></script>
<script src="/i18next.js"></script>
<script>

// JavaScript without nice helpers such as jQuery to ensure this works stand-alone

var questions = [];
var question = {};

i18n.init({ fallbackLng: 'en' }, function(t) {
	// apply i18n and show page
	$("html").i18n().css("display", "initial");
});


function listQuestions() {
	var html = "";
	document.getElementById("questions").innerHTML = html;

	for(var i = 0; i < questions.length; ++i) {
		html += "<option value='" + i + "'>";
		html += questions[i].text;
		html += "</option>";
	}
	
	document.getElementById("questions").innerHTML = html;
}


function emptyQuestionEditor() {
	document.getElementById("text").value = "";
	for(var i = 0; i < 4; ++i) {
		document.getElementById("option" + i).value = "";
	}
	document.getElementById("questionimage").style.display = "none";
}

function fillQuestionEditor() {
	emptyQuestionEditor();
	document.getElementById("text").value = question.text;
	for(var i = 0; i < question.options.length; ++i) {
		document.getElementById("option" + i).value = question.options[i];
	}
	if(question.image) {
		document.getElementById("questionimage").src = question.image;
		document.getElementById("questionimage").style.display = "initial";
	}
}

function readQuestionEditor() {
	question.text = document.getElementById("text").value;
	for(var i = 0; i < question.options.length; ++i) {
		question.options[i] = document.getElementById("option" + i).value;
	}
	listQuestions();
}


function onQuestionSelect() {
	var selected = document.getElementById("questions").value;
	question = questions[selected];
	fillQuestionEditor();
}

function newQuiz() {
	questions = [];
	listQuestions();
	emptyQuestionEditor();
}


function newQuestion() {
	question = {
		"text" : i18n.t("textofquestion"),
		"options" : [ i18n.t("correctanswer"), i18n.t("wronganswer") + " 1", i18n.t("wronganswer") + " 2", i18n.t("wronganswer") + " 3" ]
	}

	questions[questions.length] = question;
	listQuestions();
	fillQuestionEditor();
	document.getElementById("questions").value = questions.length - 1;
}


function removeQuestion() {
	var selected = parseInt(document.getElementById("questions").value);
	questions.splice(selected, 1);
	listQuestions();
	emptyQuestionEditor();
}

function upQuestion() {
	var selected = parseInt(document.getElementById("questions").value);
	if(selected < 1) {
		return;
	}

	question = questions[selected];
	questions[selected] = questions[selected - 1];
	questions[selected - 1] = question;

	listQuestions();
	fillQuestionEditor();
	document.getElementById("questions").value = selected - 1;
}

function downQuestion() {
	var selected = parseInt(document.getElementById("questions").value);
	if(selected >= questions.length - 1) {
		return;
	}


	question = questions[selected];
	questions[selected] = questions[selected + 1];
	questions[selected + 1] = question;

	listQuestions();
	fillQuestionEditor();
	document.getElementById("questions").value = selected + 1;
}

function deleteImage() {
	delete question.image;
	emptyQuestionEditor();
	fillQuestionEditor();
}

function loadFile() {
	var files = document.getElementById("files").files;
	if(files.length < 1) {
		return;
	}

	var reader = new FileReader();
	// Closure to capture the file information.
	reader.onload = (function (theFile) {
		return function (e) {
			var loadedQuestions = JSON.parse(e.target.result);
			if(confirm("Append the quiz loaded from file to the current quiz?")) {
				for(var i = 0; i < loadedQuestions.length; ++i) {
					questions.push(loadedQuestions[i]);
				}
			} else {
				questions = loadedQuestions;
			}

			listQuestions();
			console.log(questions);
		};
	})(files[0]);

	reader.readAsText(files[0], "UTF-8");
	emptyQuestionEditor();
}


function saveToFile() {
	var string = JSON.stringify(questions);

	var link = document.getElementById("savelink");
	link.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(string);

	return true;
}

/*
 * Code for adding image data
 */

var MAXWIDTH = 640;
var MAXHEIGHT = 480;

var target = document;
target.addEventListener("dragover", function(e){e.preventDefault();}, true);
target.addEventListener("drop", function(e){
	e.preventDefault();
	var file = e.dataTransfer.files[0];
	if(!file.type.match(/image.*/)){
		// not an image file!
		return;
	}

	var reader = new FileReader();
	reader.onload = function(e){
		var image = new Image();
		image.onload = function() {
			if(image.width > MAXWIDTH) {
				image.height *= MAXWIDTH / image.width;
				image.width = MAXWIDTH;
			}

			if(image.height > MAXHEIGHT) {
				image.width *= MAXHEIGHT / image.height;
				image.height = MAXHEIGHT;
			}

			var canvas = document.createElement("canvas");
			canvas.width = image.width;
			canvas.height = image.height;
			var ctx = canvas.getContext("2d");
			ctx.fillStyle = "#ffffff";
			ctx.fillRect(0, 0, canvas.width, canvas.height);
			ctx.drawImage(image, 0, 0, image.width, image.height);

			if(question.text) {
				question.image = canvas.toDataURL("image/jpeg", 0.7);
				var imgelem = document.getElementById("questionimage");
				imgelem.src = question.image;
				imgelem.style.display = "initial";
			}

		};
		image.src = e.target.result;
	};
	reader.readAsDataURL(file);
}, true);


</script>

</body>
</html>
